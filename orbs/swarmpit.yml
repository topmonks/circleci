version: 2.1

description: >
  Deploy your stacks to Docker Swarm via Swarmpit API.

display:
  home_url: https://swarmpit.io/
  source_url: https://github.com/topmonks/circleci

commands:
  deploy_stack:
    description: >
      Deploys docker-compose.yml file as stack via Swarmpit API. Creates new or updates existing stack.
      Swarmpit API Key and URL should be set via Context with `SWARMPIT_API_URL` and `SWARMPIT_API_KEY` variables.
    parameters:
      stack_name:
        type: string
        description: Name of the stack to deploy.
      compose_file_path:
        type: string
        description: Path to stack definition (docker-compose) file.
        default: docker-compose.yml
      swarmpit_api_url:
        type: string
        description: URL of API endpoint of your Swarmpit instance. eg. https://swarmpit.my.cloud/api
        default: "$SWARMPIT_API_URL"
      swarmpit_api_key:
        type: string
        description: API Key to access Swarmpit API. You will get it in Swarmpit account management.
        default: "$SWARMPIT_API_KEY"
    steps:
      - run:
          name: Deploy stack << parameters.stack_name >>
          description: >
            Checks for existing stack and creates or updates stack with docker compose file definition
          command: |
            # Check for existing stack: 200 - exists, 400 - doesn't exist
            STATUS=$(curl -I -sS -o /dev/null -w "%{http_code}" -X GET -H 'Accept: application/json' -H "authorization: << parameters.swarmpit_api_key >>" "<< parameters.swarmpit_api_url >>/stacks/<< parameters.stack_name >>/compose")
            if [ "$STATUS" = "200" ]; then echo 'Will update stack << parameters.stack_name >>'; else echo 'Will create stack << parameters.stack_name >>'; fi
            URL="<< parameters.swarmpit_api_url >>/stacks$([ "$STATUS" = "200" ] && echo '/<< parameters.stack_name >>' || echo '')"
            jq -n --arg compose "$(< << parameters.compose_file_path >>)" '{ "name": "<< parameters.stack_name >>", "spec": { "compose": $compose } }' | \
            curl -sS -X POST -d @- -H 'Content-Type: application/json' -H 'Accept: application/json' -H "authorization: << parameters.swarmpit_api_key >>" "$URL"

examples:
  stack_deploy:
    description: >
      Push newly build image to Docker Hub and then deploy stack definition in `./docker-compose.yml` to Swarm.
      Swarmpit API endpoint and API Key are stored in `org-swarmpit` CircleCI context.
    usage:
      version: 2.1

      orbs:
        docker: circleci/docker@1.4.0
        swarmpit: topmonks/swarmpit@1.0.0

      jobs:
        # ...
        docker_deploy:
          executor: docker/docker
          steps:
            - setup_remote_docker
            - checkout
            - docker/check
            - docker/push:
                image: my-org/my-service
                tag: latest
            - swarmpit/deploy_stack:
                stack_name: my-service

      workflows:
        build_and_deploy:
          jobs:
            # ...
            - docker_deploy:
                context: org-swarmpit
                requires:
                # ...
                filters:
                  branches:
                    only: trunk
